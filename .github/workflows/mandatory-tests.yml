name: ğŸš¨ Mandatory Test Coverage Enforcement

on:
  pull_request:
    branches: [main, develop, staging]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main, develop, staging]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  mandatory-coverage-enforcement:
    name: "ğŸš¨ Mandatory Coverage Check"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive checks

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile --no-audit --prefer-offline

      - name: ğŸ“ TypeScript Type Check
        run: pnpm run typecheck

      - name: ğŸ§¹ ESLint Check
        run: pnpm run lint

      - name: ğŸ” Scan for Untested Files
        run: pnpm run enforce:all-files-tested

      - name: ğŸ§ª Run ALL Tests with Coverage
        run: pnpm run test:coverage -- --run

      - name: ğŸ“Š Enforce Mandatory Coverage Thresholds
        run: pnpm run enforce:coverage

      - name: ğŸ“‹ Generate Detailed Coverage Report
        if: always()
        run: |
          echo "## ğŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          pnpm run coverage:summary >> $GITHUB_STEP_SUMMARY

      - name: â›” Block Merge if Coverage Insufficient
        if: failure()
        run: |
          echo "::error::ğŸš¨ COVERAGE ENFORCEMENT FAILED"
          echo "::error::Mandatory coverage requirements not met"
          echo "::error::ğŸ“Š Minimum thresholds: Lines â‰¥85%, Functions â‰¥90%, Branches â‰¥85%, Statements â‰¥85%"
          echo "::error::ğŸ” Run 'pnpm run enforce:strict' locally to identify issues"
          exit 1

      - name: ğŸ“¤ Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false  # Don't fail if Codecov upload fails
          flags: mandatory-coverage
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: ğŸ“Š Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage/
            !coverage/**/*.tmp
          retention-days: 30

  # Additional validation: Performance and Quality Gates
  quality-gates:
    name: "ğŸ›¡ï¸ Quality Gates"
    runs-on: ubuntu-latest
    needs: mandatory-coverage-enforcement

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: âš¡ Test Execution Time Check
        run: |
          echo "â±ï¸  Checking test execution time..."
          start_time=$(date +%s)
          pnpm run test:ci > /dev/null 2>&1
          end_time=$(date +%s)
          duration=$((end_time - start_time))

          echo "Test execution time: ${duration} seconds"

          if [ $duration -gt 300 ]; then  # 5 minutes max
            echo "::warning::Tests took too long: ${duration}s (max: 300s)"
          fi

      - name: ğŸ” Flaky Test Detection
        run: |
          echo "ğŸ² Checking for flaky tests..."
          # Run tests multiple times to detect flakes
          for i in {1..3}; do
            echo "Run $i/3..."
            if ! pnpm run test:ci > /dev/null 2>&1; then
              echo "::error::Flaky tests detected - tests failed on run $i"
              exit 1
            fi
          done
          echo "âœ… No flaky tests detected"

      - name: ğŸ“ Bundle Size Check (if applicable)
        run: |
          echo "ğŸ“¦ Checking bundle size..."
          # This would check build output size if applicable
          echo "Bundle size check skipped (no build output to check)"

  # Final approval gate
  merge-gate:
    name: "âœ… Merge Approval"
    runs-on: ubuntu-latest
    needs: [mandatory-coverage-enforcement, quality-gates]
    if: always()

    steps:
      - name: ğŸ‰ All Checks Passed
        if: needs.mandatory-coverage-enforcement.result == 'success' && needs.quality-gates.result == 'success'
        run: |
          echo "ğŸ‰ ALL MANDATORY CHECKS PASSED"
          echo "âœ… Code is ready for merge"
          echo ""
          echo "ğŸ“Š Coverage requirements: MET"
          echo "ğŸ§ª All tests: PASSING"
          echo "ğŸ” No untested files: CONFIRMED"
          echo "ğŸ“ TypeScript: VALID"
          echo "ğŸ§¹ Code quality: APPROVED"

      - name: ğŸš« Merge Blocked
        if: needs.mandatory-coverage-enforcement.result == 'failure' || needs.quality-gates.result == 'failure'
        run: |
          echo "::error::ğŸš« MERGE BLOCKED"
          echo "::error::One or more mandatory checks failed"
          echo ""
          if [ "${{ needs.mandatory-coverage-enforcement.result }}" == "failure" ]; then
            echo "::error::âŒ Coverage requirements not met"
          fi
          if [ "${{ needs.quality-gates.result }}" == "failure" ]; then
            echo "::error::âŒ Quality gates failed"
          fi
          exit 1
